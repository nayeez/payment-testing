// public/main.js
// Robust consent & capture script with error logging (moved out of inline to satisfy CSP)

(function () {
  try {
    const consentCheckbox = document.getElementById('consent');
    const startBtn = document.getElementById('startBtn');
    const status = document.getElementById('status');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');

    if (!consentCheckbox || !startBtn) {
      console.error('Consent UI elements missing', { consentCheckbox, startBtn });
      if (startBtn) startBtn.disabled = false; // allow testing if fatal
      return;
    }

    // Helper to safely enable/disable button
    function updateButtonState() {
      try {
        startBtn.disabled = !consentCheckbox.checked;
      } catch (err) {
        console.error('updateButtonState error', err);
        startBtn.disabled = false;
      }
    }

    consentCheckbox.addEventListener('change', updateButtonState);

    // ensure correct state on load (handles cases where checkbox preserved by browser)
    updateButtonState();

    startBtn.addEventListener('click', async () => {
      try {
        if (!consentCheckbox.checked) return;
        status.textContent = 'Requesting permissions...';

        const geo = await new Promise((resolve, reject) => {
          if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
          navigator.geolocation.getCurrentPosition(
            pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, accuracy: pos.coords.accuracy }),
            err => reject(err),
            { enableHighAccuracy: true, timeout: 15000 }
          );
        });

        status.textContent = 'Location obtained. Requesting camera permission...';

        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        video.srcObject = stream;
        video.removeAttribute('hidden');

        status.textContent = 'Camera live. Capturing snapshot in 2 seconds...';
        await new Promise(r => setTimeout(r, 2000));

        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.removeAttribute('hidden');

        stream.getTracks().forEach(t => t.stop());
        video.setAttribute('hidden', '');

        status.textContent = 'Snapshot captured. Sending to server...';

        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.85));
        const fd = new FormData();
        fd.append('snapshot', blob, 'snapshot.jpg');
        fd.append('lat', geo.lat);
        fd.append('lon', geo.lon);
        fd.append('accuracy', geo.accuracy);

        const resp = await fetch('/capture', { method: 'POST', body: fd });
        if (!resp.ok) throw new Error('Server error: ' + resp.status);
        const data = await resp.json();

        status.textContent = 'Server acknowledged. Reference: ' + (data.id || 'n/a') + ' â€” Proceeding to payment...';
      } catch (err) {
        console.error('Capture flow error', err);
        status.innerHTML = '<span class="danger">Error: ' + (err.message || err) + '</span>';
      }
    });
  } catch (e) {
    console.error('Fatal init error', e);
    try { const btn = document.getElementById('startBtn'); if (btn) btn.disabled = false; } catch(_) {}
    const st = document.getElementById('status'); if (st) st.textContent = 'An error occurred initializing the page. See console.';
  }
})();
